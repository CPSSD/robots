<!DOCTYPE html>
<html>

    <head>
        <title> Map View </title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

        <script>
// Change this to change the size of the map.
var block_size = 20;

// Store the input destination of the robot.
var destX = 0;
var destY = 0;

// Handy function to update the map.
function updateMap(canvasObject) {
    var ctx = canvasObject.getContext("2d");
    getMapData(ctx);
}

// Fetches map data from a URL and dispatches to draw the map.
function getMapData(canvasContext) {
    $.getJSON('/map/bit', function(data) {
            //alert(data);
            //console.log(data);
            //console.log(JSON.parse(data));
            drawMap(canvasContext, data);
    });
}

// Draws the map with the current robot location, walls and empty spaces.
function drawMap(canvasContext, mapObject) {
    // Change the canvas size depending on the size of the map.
    canvasContext.canvas.height = block_size*mapObject.map.length;
    canvasContext.canvas.width = block_size*mapObject.map[0].length;

    // Get the current robot position co-ordinates.
    var robotX = mapObject.robotX;
    var robotY = mapObject.robotY;

    // Update the map received with positions for the destination and current robot location.
    mapObject.map[robotX][robotY] = 2;

    // TODO: Get destination from server?
    mapObject.map[destX][destY] = 3;

    for (var i = 0; i < mapObject.map.length; i++) {
        for (var j = 0; j < mapObject.map[i].length; j++) {
            if (i == mapObject.robotY && j == mapObject.robotX) {				
                // Robot location
                canvasContext.fillStyle = "#0000FF";
                canvasContext.fillRect(block_size*j, block_size*i, block_size, block_size);
            } else if (mapObject.map[i][j]) {	
                // Wall
                canvasContext.fillStyle = "#000000";
                canvasContext.fillRect(block_size*j, block_size*i, block_size, block_size);
            } else {
                // Empty space
                canvasContext.fillStyle = "#FFFFFF";
                canvasContext.fillRect(block_size*j, block_size*i, block_size, block_size);
            }
        }
    }
}

// Zooms out in the map by reducing the block size.
function zoomOut() {
    block_size -= 5;
    updateMap(document.getElementById("mapCanvas"));
}

// Zooms in in the map by increasing the block size.
function zoomIn() {
    block_size += 5;
    updateMap(document.getElementById("mapCanvas"));
}

// Refreshes the map.
function refreshMap() {
    updateMap(document.getElementById("mapCanvas"));
}

// Updates the destination on the map.
// Called whenever the map is touched.
function updateDestination() {
    var canvasObject = document.getElementById("mapCanvas");
    var ctx = canvasObject.getContext("2d");

    canvasContext.fillStyle = "#00FF00";
    // TODO: Possibly mixed up the X and Ys...
    canvasContext.fillRect(block_size*destX, block_size*destY, block_size, block_size);
}

// Function to set the destination variables when the canvas is clicked.
function getPosition(event) {
    var rawX = event.x;
    var rawY = event.y;

    // Translate raw coordinates to X/Y positions in the grid.
    destX = rawX / block_size;
    destY = rawY / block_size;

    // Draw the destination on the map.
    updateDestination();
}

// Registers a touch handler on the map to get the destination variables.
// TODO: May not work in Firefox!
function registerTouchHandler() {
    var canvas =  document.getElementById("mapCanvas");
    canvas.addEventListener("mousedown", getPosition, false);
}

// Gets an initial map and registers a handler for clicks on the canvas.
function init() {
    refreshMap();
    registerTouchHandler();
}

// Downloads the current map to the device.
function downloadMap() {
    // TODO:
    return 0;
}

        </script>
    </head>


    <body>
        <canvas id="mapCanvas" width="200" height="100" style="border:1px solid #c3c3c3;">
            Your browser does not support the HTML5 canvas tag.
        </canvas>
        <br/>

        <button value="Zoom Out" onClick="zoomOut()">Zoom Out</button>
        <button value="Zoom In" onClick="zoomIn()"> Zoom In </button>
        <br/>
        <button value="Refresh Map" onClick="refreshMap()"> Refresh Map </button>
        <br/>
        <button value="Download Map" onClick="downloadMap()"> Download Map </button>
        <!-- <input type="file" value="Upload Map" onClick="uploadMap()"/> -->

        <script>
// Gets an initial map and registers a handler for clicks on the canvas.
init();
        </script>

    </body>
</html>

